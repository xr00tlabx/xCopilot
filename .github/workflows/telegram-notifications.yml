name: ğŸš€ Telegram Notifications - xCopilot

on:
  push:
    branches: [ master, dev, pr-* ]
  pull_request:
    types: [opened, closed, synchronize]
  release:
    types: [published]
  workflow_run:
    workflows: ["Build and Test"]
    types: [completed]

jobs:
  notify-telegram:
    runs-on: ubuntu-latest
    name: ğŸ“± Send Telegram Notification
    
    steps:
    - name: ğŸ”„ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸ› ï¸ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: ğŸ“Š Get Project Info
      id: project_info
      run: |
        echo "commit_hash=${GITHUB_SHA:0:7}" >> $GITHUB_OUTPUT
        echo "branch_name=${GITHUB_REF#refs/heads/}" >> $GITHUB_OUTPUT
        echo "repo_name=${GITHUB_REPOSITORY#*/}" >> $GITHUB_OUTPUT
        echo "author_name=${GITHUB_ACTOR}" >> $GITHUB_OUTPUT
        
    - name: ğŸ“ Create Notification Message
      id: message
      run: |
        if [[ "${{ github.event_name }}" == "push" ]]; then
          MESSAGE="ğŸ”¥ *NOVO PUSH* no xCopilot!
        
        ğŸŒ¿ *Branch:* \`${{ steps.project_info.outputs.branch_name }}\`
        ğŸ‘¤ *Author:* ${{ steps.project_info.outputs.author_name }}
        ğŸ”— *Commit:* \`${{ steps.project_info.outputs.commit_hash }}\`
        
        ğŸ“ *Mensagem:*
        ${{ github.event.head_commit.message }}
        
        ğŸ”— [Ver no GitHub](${{ github.event.compare }})"
        
        elif [[ "${{ github.event_name }}" == "pull_request" ]]; then
          if [[ "${{ github.event.action }}" == "opened" ]]; then
            MESSAGE="ğŸ¯ *NOVO PULL REQUEST* no xCopilot!
            
        ğŸ†” *PR #${{ github.event.number }}*
        ğŸ‘¤ *Author:* ${{ github.event.pull_request.user.login }}
        ğŸŒ¿ *Branch:* \`${{ github.event.pull_request.head.ref }}\` â†’ \`${{ github.event.pull_request.base.ref }}\`
        
        ğŸ“ *TÃ­tulo:*
        ${{ github.event.pull_request.title }}
        
        ğŸ”— [Revisar PR](${{ github.event.pull_request.html_url }})"
        
          elif [[ "${{ github.event.action }}" == "closed" ]]; then
            if [[ "${{ github.event.pull_request.merged }}" == "true" ]]; then
              MESSAGE="âœ… *PR MERGED* no xCopilot!
              
        ğŸ†” *PR #${{ github.event.number }}*
        ğŸ‘¤ *Author:* ${{ github.event.pull_request.user.login }}
        ğŸŒ¿ *Branch:* \`${{ github.event.pull_request.head.ref }}\` â†’ \`${{ github.event.pull_request.base.ref }}\`
        
        ğŸ“ *TÃ­tulo:*
        ${{ github.event.pull_request.title }}
        
        ğŸ‰ *Status:* MERGED com sucesso!"
            else
              MESSAGE="âŒ *PR FECHADO* no xCopilot!
              
        ğŸ†” *PR #${{ github.event.number }}*
        ğŸ‘¤ *Author:* ${{ github.event.pull_request.user.login }}
        
        ğŸ“ *TÃ­tulo:*
        ${{ github.event.pull_request.title }}
        
        âš ï¸ *Status:* Fechado sem merge"
            fi
          fi
          
        elif [[ "${{ github.event_name }}" == "release" ]]; then
          MESSAGE="ğŸš€ *NOVA RELEASE* do xCopilot!
          
        ğŸ·ï¸ *VersÃ£o:* ${{ github.event.release.tag_name }}
        ğŸ‘¤ *Author:* ${{ github.event.release.author.login }}
        
        ğŸ“ *Nome:*
        ${{ github.event.release.name }}
        
        ğŸ”— [Download Release](${{ github.event.release.html_url }})"
        
        elif [[ "${{ github.event_name }}" == "workflow_run" ]]; then
          if [[ "${{ github.event.workflow_run.conclusion }}" == "success" ]]; then
            MESSAGE="âœ… *BUILD SUCCESS* no xCopilot!
            
        ğŸ”„ *Workflow:* ${{ github.event.workflow_run.name }}
        ğŸŒ¿ *Branch:* \`${{ github.event.workflow_run.head_branch }}\`
        ğŸ‘¤ *Author:* ${{ github.event.workflow_run.head_commit.author.name }}
        
        âœ¨ *Status:* CompilaÃ§Ã£o bem-sucedida!"
          else
            MESSAGE="âŒ *BUILD FAILED* no xCopilot!
            
        ğŸ”„ *Workflow:* ${{ github.event.workflow_run.name }}
        ğŸŒ¿ *Branch:* \`${{ github.event.workflow_run.head_branch }}\`
        ğŸ‘¤ *Author:* ${{ github.event.workflow_run.head_commit.author.name }}
        
        âš ï¸ *Status:* Falha na compilaÃ§Ã£o!"
          fi
        fi
        
        # Escapar caracteres especiais para Markdown
        MESSAGE=$(echo "$MESSAGE" | sed 's/\./\\./g' | sed 's/-/\\-/g' | sed 's/!/\\!/g')
        
        echo "telegram_message<<EOF" >> $GITHUB_OUTPUT
        echo "$MESSAGE" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
    - name: ğŸ“± Send to Telegram
      if: steps.message.outputs.telegram_message != ''
      run: |
        curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
          -H "Content-Type: application/json" \
          -d "{
            \"chat_id\": \"${{ secrets.TELEGRAM_CHAT_ID }}\",
            \"text\": \"${{ steps.message.outputs.telegram_message }}\",
            \"parse_mode\": \"MarkdownV2\",
            \"disable_web_page_preview\": true
          }"
        
    - name: ğŸ¯ Send Status Update
      if: always()
      run: |
        if [[ "${{ job.status }}" == "success" ]]; then
          STATUS_MESSAGE="âœ… NotificaÃ§Ã£o enviada com sucesso para o Telegram!"
        else
          STATUS_MESSAGE="âŒ Falha ao enviar notificaÃ§Ã£o para o Telegram!"
        fi
        
        curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
          -H "Content-Type: application/json" \
          -d "{
            \"chat_id\": \"${{ secrets.TELEGRAM_CHAT_ID }}\",
            \"text\": \"ğŸ¤– *xCopilot CI/CD*\\n\\n$STATUS_MESSAGE\",
            \"parse_mode\": \"MarkdownV2\"
          }"
